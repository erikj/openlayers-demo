// Generated by CoffeeScript 1.10.0
(function() {
  var CATMAP, XdrawLinestring, drawLinestring, makePlaneMarker, newPlaneLayer, onFeatureSelect, onFeatureUnselect, straightPath;

  CATMAP = {};

  this.CATMAP = CATMAP;

  CATMAP.load_map = function(map_div_name) {
    var bottom, boulder, bounds, center, controls, geoProj, goesCoImages, groundOverlayFilenames, i, image, imageLayer, images, j, k, kmlDir, kmlFilename, kmlFilenames, kmlLayer, kmlLayers, kmlSelector, kmlUrl, l, latLonBounds, layerSwitcher, left, len, len1, len2, len3, len4, m, map, mendoza, mercProj, mtsat2Images, mtsat4kmImages, multiplier, multipliers, n, ocm, osm, osmResolutions, right, top;
    geoProj = new OpenLayers.Projection("EPSG:4326");
    mercProj = new OpenLayers.Projection("EPSG:900913");
    CATMAP.geoProj = geoProj;
    CATMAP.mercProj = mercProj;
    layerSwitcher = new OpenLayers.Control.LayerSwitcher;
    CATMAP.graticuleControl = new OpenLayers.Control.Graticule;
    controls = [new OpenLayers.Control.KeyboardDefaults, CATMAP.graticuleControl, layerSwitcher, new OpenLayers.Control.Navigation];
    map = new OpenLayers.Map(map_div_name, {
      controls: controls
    });
    CATMAP.graticuleControl.deactivate();
    setInterval("CATMAP.graticuleControl.activate()", 1000);
    layerSwitcher.maximizeControl();
    CATMAP.map = map;
    osmResolutions = [156543.03390625, 78271.516953125, 39135.7584765625, 19567.87923828125, 9783.939619140625, 4891.9698095703125, 2445.9849047851562, 1222.9924523925781, 611.4962261962891, 305.74811309814453, 152.87405654907226, 76.43702827453613, 38.218514137268066, 19.109257068634033, 9.554628534317017, 4.777314267158508, 2.388657133579254, 1.194328566789627, 0.5971642833948135];
    osm = new OpenLayers.Layer.OSM('Open Street Map', null, {
      resolutions: osmResolutions,
      serverResolutions: osmResolutions,
      transitionEffect: 'resize',
      wrapDateLine: true
    });
    map.addLayer(osm);
    ocm = new OpenLayers.Layer.OSM("OpenCycleMap", ["http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png", "http://b.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png", "http://c.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png"]);
    map.addLayer(ocm);
    boulder = new OpenLayers.LonLat(-105.3, 40.028);
    mendoza = new OpenLayers.LonLat(-68.0, -35.0);
    center = mendoza;
    map.setCenter(center.transform(geoProj, mercProj), 6);
    kmlDir = "kml";
    groundOverlayFilenames = [];
    kmlFilenames = [];
    drawLinestring();
    drawLinestring([-180, 10], [-180, -10], '#ff9900');
    kmlLayers = [];
    for (i = j = 0, len = groundOverlayFilenames.length; j < len; i = ++j) {
      kmlFilename = groundOverlayFilenames[i];
      kmlUrl = "" + (window.location['href'].replace(/\/[^\/]*$/, '/')) + kmlDir + "/" + kmlFilename;
      OpenLayers.Request.GET({
        url: kmlUrl,
        callback: function(response, kmlUrl) {
          var east, eastElement, element, groundOverlayBounds, groundOverlayElements, groundOverlayImage, iconElement, iconHref, iconHrefElement, iconName, k, kmlDom, latLonBoxElement, latLonGroundOverlayBounds, len1, north, northElement, results, south, southElement, west, westElement, xmlParser;
          if (response.status === 200) {
            xmlParser = new OpenLayers.Format.XML();
            kmlDom = xmlParser.read(response.responseText);
            groundOverlayElements = xmlParser.getElementsByTagNameNS(kmlDom, "*", "GroundOverlay");
            console.log(groundOverlayElements.length);
            if (groundOverlayElements.length < 1) {

            } else {
              results = [];
              for (k = 0, len1 = groundOverlayElements.length; k < len1; k++) {
                element = groundOverlayElements[k];
                iconElement = xmlParser.getElementsByTagNameNS(element, '*', 'Icon')[0];
                iconHrefElement = xmlParser.getElementsByTagNameNS(iconElement, '*', 'href')[0];
                iconHref = iconHrefElement.firstChild.nodeValue;
                latLonBoxElement = xmlParser.getElementsByTagNameNS(element, '*', 'LatLonBox')[0];
                northElement = xmlParser.getElementsByTagNameNS(latLonBoxElement, '*', 'north')[0];
                southElement = xmlParser.getElementsByTagNameNS(latLonBoxElement, '*', 'south')[0];
                eastElement = xmlParser.getElementsByTagNameNS(latLonBoxElement, '*', 'east')[0];
                westElement = xmlParser.getElementsByTagNameNS(latLonBoxElement, '*', 'west')[0];
                north = northElement.firstChild.nodeValue.replace(/(^\s+|\s+$)/g, '');
                south = southElement.firstChild.nodeValue.replace(/(^\s+|\s+$)/g, '');
                east = eastElement.firstChild.nodeValue.replace(/(^\s+|\s+$)/g, '');
                west = westElement.firstChild.nodeValue.replace(/(^\s+|\s+$)/g, '');
                console.log("iconHref: " + iconHref);
                latLonGroundOverlayBounds = [west, south, east, north];
                groundOverlayBounds = new OpenLayers.Bounds(latLonGroundOverlayBounds).transform(CATMAP.geoProj, CATMAP.mercProj);
                iconName = iconHref.match(/\/([^\/]*)$/)[1];
                groundOverlayImage = new OpenLayers.Layer.Image(iconName, iconHref, groundOverlayBounds, new OpenLayers.Size(800, 800), {
                  isBaseLayer: false,
                  alwaysInRange: true,
                  wrapDateLine: true
                });
                CATMAP.map.addLayers([groundOverlayImage]);
                results.push(groundOverlayImage.setOpacity(.5));
              }
              return results;
            }
          } else {
            return console.log(request.status + " ERROR: " + request.responseText);
          }
        }
      });
    }
    for (i = k = 0, len1 = kmlFilenames.length; k < len1; i = ++k) {
      kmlFilename = kmlFilenames[i];
      kmlLayers.push(new OpenLayers.Layer.Vector(kmlFilename, {
        strategies: [new OpenLayers.Strategy.Fixed()],
        protocol: new OpenLayers.Protocol.HTTP({
          url: kmlDir + "/" + kmlFilename,
          format: new OpenLayers.Format.KML({
            extractStyles: true,
            extractAttributes: true
          })
        })
      }));
    }
    for (l = 0, len2 = kmlLayers.length; l < len2; l++) {
      kmlLayer = kmlLayers[l];
      console.log(kmlLayer);
      kmlLayer.events.on({
        "featureselected": onFeatureSelect,
        "featureunselected": onFeatureUnselect
      });
    }
    map.addLayers(kmlLayers);
    kmlSelector = new OpenLayers.Control.SelectFeature(kmlLayers);
    map.addControl(kmlSelector);
    kmlSelector.activate();
    multipliers = [-1, 0];
    mtsat4kmImages = ['img/ops.MTSAT-2.201308012032.ch1_vis.jpg', 'img/ops.MTSAT-2.201308012032.ch2_thermal_IR.jpg', 'img/ops.MTSAT-2.201308012032.ch4_water_vapor.jpg'];
    mtsat2Images = ['img/ops.MTSAT-2.201401272201.CONTRAST_GUAM_ch1_vis.jpg'];
    goesCoImages = ['img/satellite.GOES-13.201610042137.1km_CO_ch1_vis.jpg'];
    for (m = 0, len3 = multipliers.length; m < len3; m++) {
      multiplier = multipliers[m];
      images = ['img/model.CAMChem_NCAR_1deg.201401090000.072_200hPa_OH_gis.png'];
      images = ['img/radar.SMN_AR_Radar.201811262216.Mendoza_Reflectivity.gif'];
      top = -31.27;
      bottom = -37.42;
      left = -71.67;
      right = -65.17;
      latLonBounds = [left + (360 * multiplier), bottom, right + (360 * multiplier), top];
      bounds = new OpenLayers.Bounds(latLonBounds).transform(geoProj, mercProj);
      for (n = 0, len4 = images.length; n < len4; n++) {
        image = images[n];
        imageLayer = new OpenLayers.Layer.Image(image, image, bounds, new OpenLayers.Size(2200, 1800), {
          isBaseLayer: false,
          alwaysInRange: true,
          wrapDateLine: true
        });
        map.addLayers([imageLayer]);
        imageLayer.setOpacity(.5);
      }
    }
    return map;
  };

  onFeatureSelect = function(event) {
    var content, feature, popup;
    feature = event.feature;
    console.log(feature);
    content = "<h2>" + feature.attributes.name + "</h2>" + feature.attributes.description;
    console.log(feature);
    console.log(feature.attributes.description);
    popup = new OpenLayers.Popup.FramedCloud("chickenXXX", feature.geometry.getBounds().getCenterLonLat(), new OpenLayers.Size(100, 100), content, null, true);
    feature.popup = popup;
    return CATMAP.map.addPopup(popup);
  };

  onFeatureUnselect = function(event) {
    var feature;
    feature = event.feature;
    console.log(feature);
    if (feature.popup) {
      CATMAP.map.removePopup(feature.popup);
      feature.popup.destroy();
      return delete feature.popup;
    }
  };

  newPlaneLayer = function() {
    var icon, planeLayer;
    console.log('A');
    planeLayer = new OpenLayers.Layer.Vector('gv-layer', {
      visibility: true,
      displayInLayerSwitcher: true,
      'calculateInRange': function() {
        return true;
      },
      numZoomLevels: 18
    });
    console.log('B');
    icon = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(-105, 40).transform(CATMAP.geoProj, CATMAP.mercProj), {
      name: 'gv-icon',
      description: "plane description"
    }, {
      externalGraphic: 'img/blueplane.png',
      graphicWidth: 30,
      graphicHeight: 30,
      graphicOpacity: 0.8
    });
    icon.style.rotation = '-450';
    console.log('C');
    console.log('D');
    planeLayer.addFeatures([icon]);
    console.log('E');
    return planeLayer;
  };

  makePlaneMarker = function() {
    var icon, iconSize, lonLat, markers;
    lonLat = new OpenLayers.LonLat(-105, 40).transform(CATMAP.geoProj, CATMAP.mercProj);
    markers = new OpenLayers.Layer.Markers('Markers');
    CATMAP.map.addLayer(markers);
    iconSize = OpenLayers.Size(30, 30);
    icon = OpenLayers.Icon('img/blueplane.png', iconSize);
    return markers.addMarker(new OpenLayers.Marker(lonLat, icon));
  };

  straightPath = function(startPoint, endPoint) {
    console.log("straightPath()");
    console.log(startPoint);
    console.log(endPoint);
    if (Math.abs(startPoint.x - endPoint.x) > 180) {
      if (startPoint.x < endPoint.x) {
        endPoint.x -= 360;
      } else {
        endPoint.x += 360;
      }
    }
    return [startPoint, endPoint];
  };

  XdrawLinestring = function(start, end) {
    var cFeature, cList, features, geoProjection, linestringLayer;
    console.log("drawLinestring()");
    console.log(start);
    console.log(end);
    geoProjection = new OpenLayers.Projection("EPSG:4326");
    cList = straightPath(new OpenLayers.Geometry.Point(start[0], start[1]), new OpenLayers.Geometry.Point(end[0], end[1]));
    console.log(cList);
    cFeature = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(cList), null, {
      strokeColor: "#0000ff",
      strokeOpacity: 0.7,
      strokeWidth: 4,
      strokeDashstyle: "longdash"
    });
    features = [cFeature];
    linestringLayer = new OpenLayers.Layer.Vector("Measure Lines", {
      visibility: true,
      displayInLayerSwitcher: false
    });
    linestringLayer.addFeatures(features);
    return CATMAP.map.addLayers([linestringLayer]);
  };

  drawLinestring = function(start, end, color) {
    var endLocation, geoProjection, linestringFeature, linestringLayer, startLocation;
    if (start == null) {
      start = [170, 0];
    }
    if (end == null) {
      end = [190, 0];
    }
    if (color == null) {
      color = "#0000ff";
    }
    console.log("drawLinestring()");
    console.log(start);
    console.log(end);
    if (Math.abs(start[0] - end[0]) > 180) {
      end[0] += start[0] < end[0] ? -360 : 360;
      console.log("adjusted longitude: " + end[0]);
    }
    geoProjection = new OpenLayers.Projection("EPSG:4326");
    startLocation = new OpenLayers.Geometry.Point(start[0], start[1]).transform(geoProjection, CATMAP.map.getProjectionObject());
    endLocation = new OpenLayers.Geometry.Point(end[0], end[1]).transform(geoProjection, CATMAP.map.getProjectionObject());
    linestringFeature = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([startLocation, endLocation]), null, {
      strokeColor: color,
      strokeOpacity: 1,
      strokeWidth: 4
    });
    linestringLayer = new OpenLayers.Layer.Vector("Measure Lines", {
      visibility: true,
      displayInLayerSwitcher: false
    });
    linestringLayer.addFeatures([linestringFeature]);
    return CATMAP.map.addLayers([linestringLayer]);
  };

}).call(this);
